<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>ANYEZRA</title><link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" /><link rel="icon" type="image/svg+xml" href="favicon.svg" /><link rel="shortcut icon" href="favicon.ico" /><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" /><link rel="manifest" href="site.webmanifest" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>:root{--chakra-color:#ff0000;--dark-bg:#050505;--glass:rgba(0,0,0,0.85);--border-glow:0 0 10px rgba(255,0,0,0.5);}*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}body{background:var(--dark-bg);margin:0;height:100vh;width:100vw;overflow:hidden;font-family:'Courier New',monospace;color:var(--chakra-color);display:flex;justify-content:center;align-items:center;transition:all 1s ease;}body::after{content:" ";display:block;position:absolute;inset:0;background:linear-gradient(rgba(18,16,16,0) 50%,rgba(0,0,0,0.25) 50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06));z-index:999;background-size:100% 2px,3px 100%;pointer-events:none;}#bg-video{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:-1;opacity:0.3;filter:grayscale(100%) contrast(1.2);}.grid-container{display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);width:100%;height:100%;padding:5px;gap:5px;transition:all 1s ease-in-out;}.grid-item{border:1px solid rgba(255,0,0,0.3);display:flex;flex-direction:column;justify-content:center;align-items:center;background:var(--glass);backdrop-filter:blur(5px);text-align:center;position:relative;overflow:hidden;transition:all 1s;}.sys-label{position:absolute;top:5px;left:5px;font-size:0.6rem;opacity:0.6;pointer-events:none;}.center-panel{border:2px solid var(--chakra-color);box-shadow:var(--border-glow);z-index:50;cursor:pointer;}.center-panel.expanded{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:95vw;height:95dvh;max-width:600px;border-radius:20px;background:black;border:3px solid var(--chakra-color);box-shadow:0 0 60px var(--chakra-color);z-index:1000;display:flex;flex-direction:column;align-items:center;padding:20px;overflow:hidden;}#circle-content{display:none;width:100%;height:100%;overflow-y:auto;padding-bottom:50px;scrollbar-width:none;}.view-section{display:none;width:100%;}.section-title{border-bottom:1px dashed red;padding-bottom:5px;margin:20px 0 10px 0;font-size:1rem;color:gold;text-transform:uppercase;letter-spacing:2px;}.chat-box{height:200px;overflow-y:auto;border:1px solid #333;padding:10px;margin-bottom:10px;font-size:0.8rem;background:#0a0a0a;display:flex;flex-direction:column;gap:8px;}.chat-msg{background:rgba(255,255,255,0.05);padding:8px;border-radius:4px;border-left:2px solid var(--chakra-color);display:flex;justify-content:space-between;align-items:flex-start;}.chat-content{flex:1;text-align:left;}.chat-actions{display:none;gap:5px;margin-left:10px;}.chat-btn{cursor:pointer;font-size:0.7rem;padding:2px 5px;border:1px solid #555;background:black;color:white;}.chat-btn:hover{background:white;color:black;}.gallery-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px;}.gallery-item{position:relative;border:1px solid #333;background:#111;padding:5px;}.gallery-media{height:120px;width:100%;overflow:hidden;display:flex;align-items:center;justify-content:center;background:black;}.gallery-media img{width:100%;height:100%;object-fit:cover;}.gallery-info{padding:5px;text-align:left;}.gallery-title{font-weight:bold;color:white;font-size:0.8rem;display:block;}.gallery-del{position:absolute;top:0;right:0;background:red;color:white;padding:2px 6px;font-size:0.7rem;cursor:pointer;display:none;}.input-group{display:flex;flex-direction:column;gap:5px;margin-bottom:10px;}input,textarea{background:#111;border:1px solid #333;color:white;padding:8px;font-family:inherit;}button.action-btn{background:var(--chakra-color);color:black;border:none;padding:10px;font-weight:bold;cursor:pointer;margin-top:5px;}body.is-admin{--chakra-color:#00ffea;}body.is-admin .chat-actions,body.is-admin .gallery-del{display:flex !important;}body.is-admin .grid-item{border-radius:50%/30%;border:none;box-shadow:inset 0 0 20px rgba(0,0,0,1);}body.is-admin .grid-item::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:conic-gradient(transparent,red,yellow,cyan,magenta,red);animation:rotate-border 4s linear infinite;z-index:-2;}body.is-admin .grid-item::after{content:'';position:absolute;inset:3px;background:black;border-radius:inherit;z-index:-1;}@keyframes rotate-border{100%{transform:rotate(360deg);}}.sharingan-mode{background-image:url('sharingan.png');background-size:cover;width:60px;height:60px;display:inline-block;border-radius:50%;animation:spin 4s infinite linear;box-shadow:0 0 20px red;}@keyframes spin{100%{transform:rotate(360deg);}}.ninja-btn{background:none;border:none;color:inherit;font-size:2rem;cursor:pointer;width:100%;height:100%;}.close-circle{position:absolute;bottom:20px;background:var(--chakra-color);color:black;border:none;padding:10px 30px;border-radius:20px;font-weight:bold;display:none;cursor:pointer;z-index:1001;}.center-panel.expanded .close-circle{display:block;}#login-modal{position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:2000;display:none;justify-content:center;align-items:center;flex-direction:column;}.login-option{margin:10px;text-align:center;}.social-vertical{display:flex;flex-direction:column;gap:10px;width:100%;padding:10px;}.social-btn{background:rgba(255,255,255,0.1);border:1px solid var(--chakra-color);padding:15px;color:white;text-decoration:none;display:flex;justify-content:space-between;align-items:center;font-size:1rem;transition:0.3s;}.social-btn:hover{background:var(--chakra-color);color:black;transform:translateX(5px);}#sys-info{font-size:0.6rem;color:#ff0000;margin-bottom:5px;font-family:'Courier New',monospace;opacity:0.8;}body.is-admin #sys-info{display:none !important;}body.is-admin .center-panel{background:url('sistemv1-02-2026.png') no-repeat center;background-size:cover;}body.is-admin .center-panel::before,body.is-admin .center-panel::after{animation:glitch-anim 2s infinite linear alternate-reverse;}body.is-admin .center-panel::after{clip-path:polygon(0 60%,100% 60%,100% 100%,0 100%);filter:hue-rotate(-50deg);transform:translate(5px);}#admin-toast{position:fixed;top:20px;right:20px;background:rgba(0,0,0,0.9);border:1px solid var(--chakra-color);padding:15px;z-index:9999;color:white;font-family:'Courier New',monospace;border-radius:5px;}.toast-bar{height:2px;background:var(--chakra-color);margin-top:10px;animation:shrinkBar 3s linear forwards;}@keyframes glitch-anim{0%{clip-path:inset(10% 0 30% 0);}100%{clip-path:inset(50% 0 20% 0);}}@keyframes glitch-shake{0%{transform:translate(0);}50%{transform:translate(-2px,2px);}100%{transform:translate(0);}}@keyframes shrinkBar{from{width:100%;}to{width:0%;}}</style>
</head>
<body>
<video id="bg-video" autoplay loop muted playsinline><source src="bg.mp4" type="video/mp4"></video>
<div id="login-modal">
<h2 style="color:cyan; text-shadow:0 0 10px cyan;">OVERRIDE</h2>
<div class="login-option" id="bio-section">
<i class="fas fa-fingerprint" style="font-size:4rem; color:red; cursor:pointer; animation:pulse 2s infinite;" onclick="triggerBio()"></i>
<p style="font-size:0.7rem; color:white;">BIOMETRIC LOGIN</p>
</div>
<div class="login-option">
<input type="password" id="admin-pass" placeholder="PASSCODE" style="text-align:center; width:200px; background:#111; color:cyan; border:1px solid cyan; padding:5px;">
<br><button onclick="attemptLogin()" class="action-btn" style="background:cyan; width:200px; color:black;">ACCESS</button>
</div>
<button onclick="document.getElementById('login-modal').style.display='none'" style="background:none; border:none; color:gray; margin-top:10px; cursor:pointer;">CANCEL</button>
</div>
<div class="grid-container">
<div class="grid-item"><span class="sys-label">SYS.01</span><button class="ninja-btn" onclick="execIndodax(this)"><i class="fas fa-robot"></i></button></div>
<div class="grid-item" id="sys-01"><span class="sys-label">SYS.02</span><small>MARKET</small></div>
<div class="grid-item"><span class="sys-label">SYS.03</span><button class="ninja-btn" onclick="execSosmed(this)"><i class="fas fa-database"></i></button></div>
<div class="grid-item" id="sys-04"><span class="sys-label">SYS.04</span><small>VISUAL</small></div>
<div class="grid-item center-panel" id="center-panel" onclick="expandHub('default')">
<div class="grid-item center-panel" id="center-panel" onclick="expandHub('default')">
<div id="sys-info">Initializing</div>
<div id="website-age" style="font-size:0.7rem; margin-top:5px;"></div>
</div>
<div id="admin-toast" style="display: none;">
<div class="toast-content"><i class="fas fa-user-shield"></i> <span>V ALPHA ONLINE</span></div>
<div class="toast-bar"></div>
</div>
<h2 id="main-title" style="margin:0; text-shadow: 0 0 10px red;">UCHIHAEZRA</h2>
<div id="website-age" style="font-size:0.7rem; margin-top:5px;"></div>
<p id="main-status" style="font-size: 0.7rem; color: #aaa;">UCHIHAEZRA</p>
<div id="circle-content" onclick="event.stopPropagation()">
<div id="view-default" class="view-section">
<div style="text-align:center; margin-bottom:20px;"><h1 style="color:var(--chakra-color);">KUWUJUDKAN IMPIAN KU MENJADI V ALPHA</h1><p style="font-size:0.8rem;">SECURE CONNECTION</p></div>
<div class="section-title">ðŸ’¬ ENCRYPTED</div>
<div id="chat-display" class="chat-box">Connecting</div>
<div class="input-group"><input type="text" id="chat-msg" placeholder="Type..."><button onclick="sendChat()" class="action-btn">SEND</button></div>
<div class="section-title">ðŸ“¸ GALLERY</div>
<div style="background:rgba(255,255,255,0.05); padding:10px; border:1px dashed #444;">
<input type="text" id="vault-title" placeholder="Title..." style="width:100%; margin-bottom:5px;">
<textarea id="vault-desc" placeholder="Description..." rows="2" style="width:100%; margin-bottom:5px;"></textarea>
<input type="file" id="vault-file" style="width:100%;">
<button onclick="uploadVault()" class="action-btn" id="btn-upload">UPLOAD</button>
<small id="upload-status" style="color:cyan; display:block; margin-top:5px;"></small></div>
<div id="gallery-display" class="gallery-grid">Loading
</div>
</div>
<div id="view-trading" class="view-section">
<div style="text-align:center; color:cyan;"><h2>TRADING BOT</h2><p style="font-size:0.7rem;">CONNECTING TO INDODAX</p><div id="trading-loader"><i class="fas fa-circle-notch fa-spin"></i></div></div>
<div id="trading-interface" style="display:none; margin-top:10px;">
<div style="border:1px solid cyan; padding:10px; background:rgba(0,255,255,0.05);">
<div style="display:flex; justify-content:space-between;"><span>IDR: <b id="wallet-idr">0</b></span><span>BTC: <b id="wallet-btc">0</b></span></div>
<div style="margin-top:5px; font-size:1.2rem; font-weight:bold; text-align:center;">1 BTC = <span id="market-price" style="color:lime;">loading</span></div>
</div>
<div style="display:flex; gap:10px; margin-top:10px;"><button onclick="tradeAction('buy')" style="flex:1; background:green; color:white; border:none; padding:10px; cursor:pointer;">BUY</button><button onclick="tradeAction('sell')" style="flex:1; background:red; color:white; border:none; padding:10px; cursor:pointer;">SELL</button></div>
<h4 class="section-title">TRADE LOGS</h4>
<div id="trade-history" style="font-size:0.7rem; color:#aaa; max-height:150px; overflow-y:auto;"></div>
</div>
</div>
<div id="view-social" class="view-section">
<h2 class="section-title">SOCIAL</h2>
<div class="social-vertical">
<a href="https://wa.me/628381000735" class="social-btn" target="_blank"><i class="fab fa-whatsapp"></i> <span>WHATSAPP</span></a>
<a href="https://instagram.com/tanahsubur01" class="social-btn" target="_blank"><i class="fab fa-instagram"></i> <span>INSTAGRAM</span></a>
<a href="https://link.dana.id/minta?full_url=https://qr.dana.id/v1/281012012025071142448416" class="social-btn" target="_blank"><i class="fas fa-wallet"></i> <span>DANA</span></a>
<a href="https://alkitab.me/in-tb/Matius/5/13" class="social-btn" target="_blank"><i class="fas fa-book-bible"></i> <span>ALKITAB</span></a>
<a href="https://share.google/ElUOLZPxafGWca1Hz" class="social-btn" target="_blank"><i class="fab fa-google"></i> <span>PROFIL GOOGLE</span></a>
</div>
</div>
<div id="view-visual" class="view-section"><h2 class="section-title">VISUAL</h2><div id="visual-container" style="width:100%; border:1px solid var(--chakra-color);"></div></div>
<div id="view-visitor" class="view-section"><h2 class="section-title">SYSTEM TRAFFIC</h2><div id="visitor-stats" style="margin-bottom:10px;">Loading stats</div><div id="visitor-list" style="font-size:0.7rem; text-align:left; background:#0a0a0a; padding:10px; border:1px solid #333; height:300px; overflow-y:auto;"></div></div>
</div>
<button class="close-circle" onclick="closeHub(event)">EXIT</button>
</div>
<div class="grid-item" id="sys-06"><span class="sys-label">SYS.06</span><small>SOCIAL</small></div>
<div class="grid-item"><span class="sys-label">SYS.07</span><button class="ninja-btn" onclick="execMusic(this)"><i class="fas fa-video"></i></button></div>
<div class="grid-item" id="sys-08" onclick="execVisitor()" style="cursor:pointer;"><span class="sys-label">SYS.08</span><small>LOGS</small><div id="mini-log" style="font-size:0.5rem; opacity:0.5;">Tap to View</div></div>
<div class="grid-item"><span class="sys-label">SYS.09</span><div id="auth-trigger" onclick="document.getElementById('login-modal').style.display='flex'" style="cursor:pointer;"><i class="fas fa-fingerprint" style="font-size:2rem;"></i></div></div>
</div>
<script>
const API_URL = "https://uchiha-backend.anyezra.workers.dev/api";
const VISITOR_API_URL = "https://uchiha-visitor.anyezra.workers.dev";
let isAdmin = false, marketInterval;
let titleTapCount = 0;

document.addEventListener("DOMContentLoaded", (() => {
    initAge();
    trackVisitor();
    checkSession();
}));

// --- FUNGSI AUTHENTICATION BARU (VERIFIKASI BACKEND) ---

async function attemptLogin() {
    const inputPass = document.getElementById("admin-pass").value;
    if (!inputPass) return alert("Masukkan Passcode!");

    // UI Loading
    const btn = document.querySelector("#login-modal .action-btn");
    const originalText = btn.innerText;
    btn.innerText = "VERIFYING...";
    btn.disabled = true;

    try {
        // Kirim password ke backend untuk dicek
        const req = await fetch(`${API_URL}/auth`, {
            method: "POST",
            body: JSON.stringify({ type: "VERIFY_PASS", pass: inputPass })
        });
        const res = await req.json();

        if (res.success) {
            setAdminSession();
            document.getElementById("admin-pass").value = ""; // Clear input
        } else {
            alert("ACCESS DENIED: " + (res.message || "Passcode Salah"));
        }
    } catch (e) {
        alert("SERVER ERROR: Gagal menghubungi backend.");
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
}

async function triggerBio() {
    try {
        // Simulasi Biometric Browser
        const challenge = new Uint8Array(32);
        window.crypto.getRandomValues(challenge);
        await navigator.credentials.create({
            publicKey: {
                challenge: challenge,
                rp: { name: "UCHIHASYSTEM" },
                user: { id: Uint8Array.from("ADMIN", c => c.charCodeAt(0)), name: "admin", displayName: "Ezra Admin" },
                pubKeyCredParams: [{ alg: -7, type: "public-key" }],
                authenticatorSelection: { authenticatorAttachment: "platform" }
            }
        });

        // Prompt Nama
        let inputName = prompt("BIOMETRIC MATCHED.\nMasukkan Nama Anda:");
        if (!inputName) return alert("LOGIN DIBATALKAN");

        // Prompt Jawaban Rahasia (Pemilik Website)
        let inputAnswer = prompt(`Halo, ${inputName}.\nSECURITY CHECK:\nNama pemilik website ini?`);
        if (!inputAnswer) return alert("LOGIN DIBATALKAN");

        // Kirim Jawaban ke Backend untuk dicek
        const req = await fetch(`${API_URL}/auth`, {
            method: "POST",
            body: JSON.stringify({ type: "VERIFY_BIO", name: inputName, answer: inputAnswer })
        });
        const res = await req.json();

        if (res.success) {
            alert(`VERIFIKASI SUKSES.\nWelcome, ${inputName}.`);
            setAdminSession();
        } else {
            alert("SECURITY ALERT: Identitas tidak dikenali oleh Server.");
        }

    } catch (e) {
        alert("SCAN FAILED / DEVICE NOT SUPPORTED");
    }
}

function setAdminSession() {
    // Cookie valid 1 jam
    document.cookie = "uchihaccess=godmode; path=/; max-age=3600"; 
    activateAdmin();
    document.getElementById("login-modal").style.display = "none";
}

function checkSession() {
    if (document.cookie.split(";").some((e => e.trim().startsWith("uchihaccess=godmode")))) {
        activateAdmin();
    }
}

function activateAdmin() {
    isAdmin = true;
    document.body.classList.add("is-admin");
    playZingSound();
    document.getElementById("admin-toast").style.display = "block";
    const title = document.getElementById("main-title");
    title.innerText = "MANGEKYO MODE";
    title.style.color = "cyan";
    setTimeout((() => { document.getElementById("admin-toast").style.display = "none" }), 3000);
    if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
}

// --- FUNGSI VAULT BARU (DENGAN EDIT) ---

async function loadVault() {
    try {
        const req = await fetch(`${API_URL}/vault`);
        const data = await req.json();
        
        document.getElementById("gallery-display").innerHTML = data.map((item => {
            let mediaContent;
            if (item.fileType && item.fileType.includes("video")) {
                mediaContent = `<video src="${item.fileUrl}" controls style="width:100%; height:100%; object-fit:cover;"></video>`;
            } else if (item.fileType && item.fileType.includes("image")) {
                mediaContent = `<img src="${item.fileUrl}" style="width:100%; height:100%; object-fit:cover;">`;
            } else {
                mediaContent = `<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:cyan;"><i class="fas fa-file-zipper" style="font-size:3rem;"></i><a href="${item.fileUrl}" target="_blank" style="font-size:0.6rem; color:white; margin-top:5px;">DOWNLOAD</a></div>`;
            }

            // Tombol Delete & Edit (Hanya muncul jika Admin/CSS class is-admin)
            const adminControls = `
                <div class="gallery-del" style="right: 25px; background: orange;" onclick="editVault('${item.id}', '${escapeHtml(item.title)}', '${escapeHtml(item.description)}')">âœŽ</div>
                <div class="gallery-del" onclick="deleteVault('${item.id}')">X</div>
            `;

            return `<div class="gallery-item">
                        <div class="gallery-media">${mediaContent}</div>
                        <div class="gallery-info">
                            <span class="gallery-title">${item.title}</span>
                            <span class="gallery-desc">${item.description}</span>
                        </div>
                        ${adminControls}
                    </div>`;
        })).join("");
    } catch (e) {
        console.log(e);
        document.getElementById("gallery-display").innerHTML = "Empty Archive";
    }
}

// Fungsi Edit Vault Baru
async function editVault(id, oldTitle, oldDesc) {
    // Unescape HTML chars untuk prompt
    const cleanTitle = oldTitle.replace(/&quot;/g, '"').replace(/&#039;/g, "'");
    const cleanDesc = oldDesc.replace(/&quot;/g, '"').replace(/&#039;/g, "'");

    const newTitle = prompt("Edit Title:", cleanTitle);
    if (newTitle === null) return; // Cancelled

    const newDesc = prompt("Edit Description:", cleanDesc);
    if (newDesc === null) return; // Cancelled

    if (newTitle === cleanTitle && newDesc === cleanDesc) return; // Gak ada perubahan

    try {
        const req = await fetch(`${API_URL}/vault`, {
            method: "PUT",
            body: JSON.stringify({ 
                type: "UPDATE_INFO", // Flag untuk backend
                id: id, 
                title: newTitle, 
                description: newDesc 
            })
        });
        
        if (req.ok) {
            loadVault(); // Reload gallery
        } else {
            alert("Gagal update info.");
        }
    } catch (e) {
        alert("Network Error");
    }
}

async function uploadVault() {
    const title = document.getElementById("vault-title").value;
    const desc = document.getElementById("vault-desc").value;
    const fileInput = document.getElementById("vault-file");
    
    if (!title || !fileInput.files[0]) return alert("Title & File wajib diisi!");
    
    const file = fileInput.files[0];
    const MAX_MB = 10; 
    
    if (!file.type.startsWith("image/") && file.size > 10 * 1024 * 1024) {
        return alert(`STOP! File terlalu besar. Batas: ${MAX_MB}MB.`);
    }

    const status = document.getElementById("upload-status");
    const btn = document.getElementById("btn-upload");
    
    status.innerText = "Processing...";
    btn.disabled = true;

    // Helper convert file to base64
    const toBase64 = file => new Promise(((resolve, reject) => {
        if (file.type.startsWith("image/")) {
            // Kompresi Gambar Client-Side
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement("canvas");
                    const scale = 1280 / img.width;
                    canvas.width = 1280;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL("image/jpeg", 0.7).split(",")[1]);
                };
                img.onerror = () => reject("Gagal load gambar");
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        } else {
            // File Non-Gambar (Video/Zip) langsung base64
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result.split(",")[1]);
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        }
    }));

    try {
        status.innerText = file.type.startsWith("image/") ? "Compressing..." : "Encoding...";
        const content = await toBase64(file);
        
        status.innerText = "Uploading...";
        const req = await fetch(`${API_URL}/vault`, {
            method: "POST",
            body: JSON.stringify({
                title: title,
                description: desc,
                filename: file.name,
                type: file.type,
                content: content
            })
        });

        if (!req.ok) throw new Error("Server Reject");

        status.innerText = "Upload Success!";
        document.getElementById("vault-title").value = "";
        document.getElementById("vault-desc").value = "";
        fileInput.value = "";
        loadVault();
    } catch (e) {
        status.innerText = "Error: " + e.message;
        alert("GAGAL UPLOAD: " + e.message);
    } finally {
        btn.disabled = false;
    }
}

async function deleteVault(id) {
    if (confirm("Hapus file ini permanen?")) {
        await fetch(`${API_URL}/vault`, {
            method: "DELETE",
            body: JSON.stringify({ id: id })
        });
        loadVault();
    }
}

// --- FUNGSI HELPER LAINNYA ---
function escapeHtml(text) {
    if (!text) return "";
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function expandHub(view = "default") {
    const panel = document.getElementById("center-panel");
    const content = document.getElementById("circle-content");
    document.querySelectorAll(".view-section").forEach((e => e.style.display = "none"));
    clearInterval(marketInterval);
    
    panel.classList.add("expanded");
    content.style.display = "block";
    document.getElementById("main-title").style.display = "none";
    
    const section = document.getElementById("view-" + view);
    if (section) section.style.display = "block";
    
    if (view === "default") { loadChat(); loadVault(); }
    if (view === "trading") { marketInterval = setInterval(loadTradingData, 5000); loadTradingData(); }
    if (view === "visitor") loadDetailedLogs();
}

function closeHub(e) {
    e.stopPropagation();
    document.getElementById("center-panel").classList.remove("expanded");
    document.getElementById("circle-content").style.display = "none";
    document.getElementById("main-title").style.display = "block";
    clearInterval(marketInterval);
}

// ... Sisanya fungsi visual/chat/sosmed/visitor (sama kayak sebelumnya, tapi hapus PASSCODE di fungsi chat) ...
// Saya ringkas fungsi chat biar kompatibel sama backend baru:

async function loadChat() {
    try {
        const res = await fetch(`${API_URL}/chat`);
        const data = await res.json();
        const display = document.getElementById("chat-display");
        display.innerHTML = data.map((msg => `
            <div class="chat-msg">
                <div class="chat-content">
                    <small style="color:#555;">[${msg.date}]</small><br>
                    <span>${msg.text}</span>
                </div>
                <div class="chat-actions">
                    <button class="chat-btn" onclick="editChat('${msg.id}', '${msg.text}')">EDIT</button>
                    <button class="chat-btn" style="color:red;" onclick="deleteChat('${msg.id}')">DEL</button>
                </div>
            </div>`)).join("");
        display.scrollTop = display.scrollHeight;
    } catch (e) {}
}

async function sendChat() {
    const txt = document.getElementById("chat-msg").value;
    if (txt) {
        document.getElementById("chat-msg").value = "";
        await fetch(`${API_URL}/chat`, {
            method: "POST",
            body: JSON.stringify({ text: txt, admin: isAdmin })
        });
        loadChat();
    }
}

async function deleteChat(id) {
    if (confirm("Hapus pesan ini?")) {
        await fetch(`${API_URL}/chat`, {
            method: "DELETE",
            body: JSON.stringify({ id: id }) 
            // Tidak kirim pass lagi, backend cek cookie
        });
        loadChat();
    }
}

async function editChat(id, oldText) {
    const newText = prompt("Edit pesan:", oldText);
    if (newText && newText !== oldText) {
        await fetch(`${API_URL}/chat`, {
            method: "PUT",
            body: JSON.stringify({ id: id, text: newText })
        });
        loadChat();
    }
}

// Fungsi animasi & visitor log
function animateBtn(e) {
    const t = e.querySelector("i");
    t.style.transition = "1s";
    t.style.transform = "rotate(720deg)";
    setTimeout((() => t.style.transform = "rotate(0deg)"), 1000);
}

function initAge() {
    const start = new Date(2006, 7, 7);
    setInterval((() => {
        const years = Math.floor((new Date - start) / 31557600000);
        document.getElementById("website-age").innerText = `AGE: ${years} YEARS RUNNING`;
    }), 1000);
}

function playZingSound() {
    const ctx = new(window.AudioContext || window.webkitAudioContext);
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.frequency.setValueAtTime(150, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(1500, ctx.currentTime + .1);
    gain.gain.exponentialRampToValueAtTime(.01, ctx.currentTime + .3);
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + .3);
}

// Track visitor (IP & Logs)
async function trackVisitor() {
    await fetch(`${VISITOR_API_URL}/visitor`, {
        method: "POST",
        body: JSON.stringify({ referrer: document.referrer })
    });
    
    // Update sys-08 (Mini Log)
    if (isAdmin) {
        const req = await fetch(`${VISITOR_API_URL}/visitor?t=${Date.now()}`);
        const data = await req.json();
        document.getElementById("sys-08").innerHTML = `<span class="sys-label">LOGS (${data.count})</span><div style="text-align:left; font-size:0.6rem; overflow:auto; height:100%;">${data.logs.map((e=>`> ${e.ip}`)).join("<br>")}</div>`;
    }
}

// Detail visitor log (Panel Besar)
async function loadDetailedLogs() {
    const list = document.getElementById("visitor-list");
    const stats = document.getElementById("visitor-stats");
    
    if (isAdmin) {
        try {
            const req = await fetch(`${VISITOR_API_URL}?t=${Date.now()}`);
            if (!req.ok) throw new Error("Database Offline");
            const data = await req.json();
            const logs = data.logs || [];
            
            stats.innerHTML = `TOTAL VISITORS: <b style="color:cyan;">${data.count||0}</b>`;
            if (logs.length === 0) {
                list.innerHTML = "<div style='text-align:center; padding:10px;'>NO DATA</div>";
            } else {
                list.innerHTML = logs.map((e => `<div style="border-bottom: 1px solid #222; padding: 8px 0; font-family: monospace; font-size: 0.75rem;"><span style="color:#00ffea;">> ${e.ip}</span><div style="color:#666; font-size: 0.6rem;">[${e.time}] - ${e.ref}</div></div>`)).join("");
            }
        } catch (e) {
            list.innerHTML = `<div style='color:red; text-align:center;'>ERROR: ${e.message}</div>`;
        }
    } else {
        list.innerHTML = "<div style='color:#555; text-align:center; padding:20px;'>RESTRICTED AREA<br><small>Admin Authentication Required</small></div>";
        stats.innerHTML = "ACCESS DENIED";
    }
}

async function execIndodax(e) {
    animateBtn(e);
    expandHub("trading");
    const req = await fetch(`${API_URL}/indodax`);
    const data = await req.json();
    document.getElementById("sys-01").innerHTML = `<span class="sys-label">MARKET</span><div style="color:cyan; font-size:0.8rem;">BTC/IDR<br>${parseInt(data.btc_idr).toLocaleString()}</div>`;
}

async function loadTradingData() {
    try {
        const req = await fetch(`${API_URL}/trading`);
        const data = await req.json();
        document.getElementById("trading-loader").style.display = "none";
        document.getElementById("trading-interface").style.display = "block";
        document.getElementById("wallet-idr").innerText = parseInt(data.idr).toLocaleString();
        document.getElementById("wallet-btc").innerText = data.btc.toFixed(4);
        const price = document.getElementById("market-price");
        price.innerText = parseInt(data.currentPrice).toLocaleString();
        price.style.color = "white";
        setTimeout((() => price.style.color = "lime"), 300);
        const history = data.history.map((e => `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #222; padding:3px;"><span style="color:${"BUY"===e.type?"lime":"red"}">${e.type}</span><span>${e.amount} BTC</span><small>${e.time.split(",")[1]}</small></div>`)).join("");
        document.getElementById("trade-history").innerHTML = history || "No trades.";
    } catch (e) {
        console.log("Trading offline");
    }
}

async function tradeAction(type) {
    const btn = event.target;
    const txt = btn.innerText;
    btn.innerText = "...";
    btn.disabled = true;
    try {
        const req = await fetch(`${API_URL}/trading`, {
            method: "POST",
            body: JSON.stringify({ action: type, amount: .01 })
        });
        if (!req.ok) {
            const res = await req.json();
            alert("ERROR: " + res.error);
        } else loadTradingData();
    } catch (e) {
        alert("Network Error");
    }
    btn.innerText = txt;
    btn.disabled = false;
}

function execSosmed(e) {
    animateBtn(e);
    expandHub("social");
    document.getElementById("sys-06").innerHTML = '<span class="sys-label">SOCIAL</span><div class="social-vertical"><a href="https://wa.me/628381000735" class="social-btn" target="_blank"><i class="fab fa-whatsapp"></i> <span>WHATSAPP</span></a><a href="https://instagram.com/tanahsubur01" class="social-btn" target="_blank"><i class="fab fa-instagram"></i> <span>INSTA</span></a><a href="https://link.dana.id/minta/2k3j4k2j3" class="social-btn" target="_blank"><i class="fas fa-wallet"></i> <span>DANA</span></a><a href="https://alkitab.me" class="social-btn" target="_blank"><i class="fas fa-book-bible"></i> <span>ALKITAB</span></a><a href="https://share.google/ElUOLZPxafGWca1Hz" class="social-btn" target="_blank"><i class="fab fa-google"></i> <span>PROFIL</span></a></div>';
}

function execMusic(e) {
    animateBtn(e);
    document.getElementById("visual-container").innerHTML = '<video src="laststand.mp4" autoplay loop muted style="width:100%; height:auto;"></video>';
    expandHub("visual");
    document.getElementById("sys-04").innerHTML = '<span class="sys-label">VISUAL</span><video src="sasuke.mp4" autoplay loop muted style="width:100%; height:100%; object-fit:cover;"></video>';
}

async function execVisitor() {
    expandHub("visitor");
}

document.getElementById("main-title").addEventListener("click", (async () => {
    if (10 === ++titleTapCount) {
        titleTapCount = 0;
        const e = prompt("Apa tujuan pemilik website?");
        if (e === "V Alpha") {
            await fetch(VISITOR_API_URL, {
                method: "POST",
                body: JSON.stringify({ type: "EMERGENCY_UNLOCK", answer: e })
            });
            alert("Lockdown Removed.");
            location.reload();
        }
    }
}));
</script>
</body>
</html>